<style type="text/css">
    .form-group{ color: #000000;}
    input{ border:none !important; text-indent: inherit !important; padding-left: 0px !important;}
    label{ font-weight: bold;!important; color: #000000;}
    #submit3{background: #72d0eb; border: none;}
    .col-xs-4{border: 4px solid #e5e6e6; padding: 0px;}
    .panel{ height: 400px;}
</style>

<!-- Ztree CSS -->
<link rel="stylesheet" href="/assets/ztree/zTreeStyle/zTreeStyle.css">

<!-- BEGIN MAIN CONTENT -->
<section id="main-content">
    <!-- BEGIN WRAPPER  -->
    <section class="wrapper site-min-height">
        <!-- BEGIN ROW  -->
        <div class="row">
            <div class="col-lg-12">
                <section class="panel col-xs-4" >
                    <header class="panel-heading">
                        <span class=""><strong><img src="../../../img/admin.png" width="35" height="35" />用户管理</strong></span>

                    </header>
                    <div class="panel-body">
                        <form id="form1" class="form-horizontal tasi-form layui-form" enctype="multipart/form-data">
                            <input type="hidden" id="id" name="id"/>
                            <div class="form-group">
                                <label class="col-xs-3 col-sm-2 control-label">用户名：</label>
                                <div class="col-xs-9 col-sm-10">
                                    <input type="text" name="username" id="username"   class="form-control layui-input">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-xs-3 col-sm-2 control-label">密码：</label>
                                <div class="col-xs-9 col-sm-10">
                                    <input type="text" name="pass" id="pass"  class="form-control layui-input">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-xs-3 col-sm-2 control-label">姓名：</label>
                                <div class="col-xs-9 col-sm-10">
                                    <input type="text" name="name" id="name"  class="form-control layui-input">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-xs-3 col-sm-2 control-label">性别：</label>
                                <div class="col-xs-9 col-sm-10">
                                    <input id="man" type="radio" checked="checked" name="sex" value="1" />男
                                    <input id="woman" type="radio"  name="sex" value="0"/>女
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-xs-3 col-sm-2 control-label">权限：</label>
                                <div class="col-xs-9 col-sm-10">
                                    <input name="privilege" type="checkbox"  value="1" />上报人
                                    <input name="privilege" type="checkbox"  value="2" />指派人
                                    <input name="privilege" type="checkbox"  value="3" />处理人
                                </div>
                            </div>

                        </form>
                    </div>                    
                </section>
					<section class="panel  col-xs-4">
                        <header class="panel-heading">
                            <i class="fa fa-hand-o-down"></i>
                            <span class="label label-primary">
                                 添加单位
                            </span>
                        </header>
                        <div class="panel-body">
                            <ul class="nav prod-cat ztree" id="treePartment">
                                数据加载中……
                            </ul>
                        </div>
                        <div class="text-center " style="position: absolute; bottom: 10px; width: 100%;">
                        	<button id="submit" class="btn btn-success btn-lg col-sm-12">保存</button>
                    	</div>
                    </section>

                    

                    <section class="panel col-xs-4">
                        <header class="panel-heading">
                            <i class="fa fa-hand-o-down"></i>
                            <span class="label label-primary">
                                 组织结构展示
                            </span>
                        </header>
                        <div class="panel-body">
                            <ul class="nav prod-cat ztree" id="show_struct">
                                数据加载中……
                            </ul>
                        </div>
                    </section>

            </div>
        </div>
        </div>
        <!-- END WRAPPER  -->
    </section>
    <!-- END MAIN CONTENT -->



</section>



<!-- Ztree --->
<script src="/assets/ztree/jquery.ztree.all.min.js"></script>
<script type="text/javascript">
    /**
     * Ztree && MultiSelect 插件
     * 选择单位
     */
    var treeObj;
    var setting = {
        check: {
            enable: true,
            chkboxType: {"Y": "", "N": ""}
        },
        async: {
            enable: true,
            url: "/admin/get_group",
            autoParam: ["id", "name=n", "level=lv"]
            // dataFilter: filter
        },
        callback: {
            // onClick: zTreeOnClick,
            onAsyncSuccess: zTreeOnAsyncSuccess,//异步加载完执行
            onCheck: zTreeCheck//当选中时执行
        }
    };

    function zTreeOnAsyncSuccess(event, treeId, treeNode, msg) {
        //去掉组织结构的选择项
        var rootNode = treeObj.getNodeByParam("id", 0, null);//得到组织结构树
        rootNode.nocheck = true;
        treeObj.refresh();//更改属性后，刷新界面
    }
    //当节点选中时选择
    function zTreeCheck(event, treeId, treeNode) {
        // console.log(treeNode)
        // console.log(treeNode.isdepartment);
        if (treeNode.isdepartment == 1) {//个人
            treeNode.getParentNode().checked = false;
            //   console.log(treeNode.getParentNode());
        } else if (treeNode.isdepartment == 0) {//单位
            var children_arr = treeNode.children;
            for (var i in children_arr) {
                children_arr[i].checked = false;
            }
        }
        treeObj.refresh();
    }
    treeObj = $.fn.zTree.init($("#treePartment"), setting);

    $("#submit").click(function () {
        var nodes = treeObj.getCheckedNodes(true);//获取到被选中的集成
        //console.log(nodes[0].id);
        if (nodes.length == 0) {//没有选中
            layer.msg("请选择一个单位",{anim:6,time:1000})
            return false;
        }else if(nodes.length > 1){
            layer.msg("最多选择一个单位",{anim:6,time:1000})
            return false;
        }

        var pri = "";
        $("input[type=checkbox]").each(function(){
            if(this.checked){
                pri += $(this).val()+",";
            }
        });
        pri = pri.substring(0,pri.length - 1)

        $.ajax({
            url: "/admin/add_person",
            method: "post",
            dataType : 'json',
            data: {
                "username": $("#username").val(),
                "password": $("#pass").val(),
                "name" : $("#name").val(),
                "sex" : $("input[name='sex']:checked").val(),
                "privilege" : pri,
                'gid':nodes[0].id,
            },
            success: function (data) {
                if (data.res == 1){
                    layer.msg('添加成功!');
                }else {
                    layer.msg('添加失败！',{anim:6});
                }
            }
        });

    });


    /**
     * 展示所有结构
     */
    var treeObj2;
    var setting2 = {
        check: {
            enable: false,
            chkboxType: {"Y": "", "N": ""}
        },
        async: {
            enable: true,
            url: "/designate/tree",
            autoParam: ["id", "name=n", "level=lv"]
            // dataFilter: filter
        },
        callback: {
            // onClick: zTreeOnClick,
            onAsyncSuccess: zTreeOnAsyncSuccess2,//异步加载完执行
            onCheck: zTreeCheck2//当选中时执行
        }
    };

    function zTreeOnAsyncSuccess2(event, treeId, treeNode, msg) {
        //去掉组织结构的选择项
        var rootNode = treeObj.getNodeByParam("id", 0, null);//得到组织结构树
        rootNode.nocheck = true;
        treeObj.refresh();//更改属性后，刷新界面
    }
    //当节点选中时选择
    function zTreeCheck2(event, treeId, treeNode) {
        // console.log(treeNode)
        // console.log(treeNode.isdepartment);
        if (treeNode.isdepartment == 1) {//个人
            treeNode.getParentNode().checked = false;
            //   console.log(treeNode.getParentNode());
        } else if (treeNode.isdepartment == 0) {//单位
            var children_arr = treeNode.children;
            for (var i in children_arr) {
                children_arr[i].checked = false;
            }
        }
        treeObj.refresh();
    }
    treeObj2 = $.fn.zTree.init($("#show_struct"), setting2);




</script>