<section id="main-content">
    <section class="wrapper site-min-height">
        <!-- BEGIN ROW  -->
        <div class="row">
            <div class="col-lg-12">
                <section class="panel">
                    <header class="panel-heading">
                        <i class="fa fa-hand-o-down"></i>
                        <span class="" >事件追踪</span>
                        <input type="button" value="事件完成" name="sjwc" id="sjwc"/>
                    </header>
                    <form class="zj">
                        <textarea cols="" rows="4" placeholder="发布你所发布的事件" class="zjk" id="zjk"></textarea>
                        <input type="button" class="zj_button" name="zj_buttom" value="发表" />
                    </form>
                    <div class="panel-body" style="display: block;">
                        <ul id="comment" class="timeline">
                            
                        </ul>
                        <ul class="timeline">
                            <!-- BEGIN CENTERING LINE -->
                            <li class="centering-line"></li>
                            <!-- END CENTERING LINE -->

                            <!-- BEGIN HIGHLIGHT TIMELINE MOMENT -->
                            <li class="item-timeline highlight text-center" id="wc">
                                <div class="buletan"></div>
                                <div class="inner-content">
                                    <h2 class="text-info"><i class="fa fa-flag-checkered"></i></h2>
                                    <h4>事件处理完成</h4>
                                    <p class="text-muted">2016年4月3日</p>
                                </div>
                                <!-- /.inner-content -->
                            </li>
                            <!-- END HIGHLIGHT TIMELINE MOMENT -->
                            
                        </ul>
                    </div>
                   
                </section>
            </div>
        </div>
        <!-- END ROW  -->
    </section>
</section>
<!-- <div id="one1"></div>-->
<!-- END SECTION -->
<input type="hidden" name="title" value="<{$title}>">
<input type="hidden" name="can_show_done_btn" value="<{$can_show_done_btn}>" id="cs">
<input type="hidden" name="eid" value="<{$eid}>" id="eid">
<input type="hidden" name="eid" value="<{$done_state}>" id="done_state">
<input type="hidden" name="eid" value="<{$end_time}>" id="end_time">

<script>



	var eid=document.getElementById('eid').value;	
	$("input[name='zj_buttom']").click(function(){
		var zjk=document.getElementById('zjk').value;
		add();
	});
	
	function getLocalTime(nS) {     
    	return new Date(parseInt(nS) * 1000).toLocaleString().replace(/:\d{1,2}$/,' ');
    }

	
	function loadData(){		
		$.ajax({
        url : 'http://202.202.2.42:82/handler/get_event_logs',
        type: 'post',
        data: 'eid='+eid,
        cache:false,
        dataType:'json',
        success:function(data){
            $.each(data,function(i,value){
            	var myDate = new Date(value.time*1000);  
            	var year= myDate.getFullYear();
            	var month= myDate.getMonth()+1; 
        	    var str1="<li class='centering-line'></li><li class='center-timeline-cat'><div class='inner'>"+year+"年"+month+"月</div></li><li class='item-timeline'>  <div class='buletan'></div><div class='inner-content'>";
        	    var str2="<div class='heading-timeline'><img alt='Avatar' class='avatar' src='/img/avatar/avatar-1.jpg'>";
        	    var time=getLocalTime(value.time)
        	    var str3="<div class='user-timeline-info'><p> "+value.name+" <small id='DateTime'>"+time+"</small></p></div></div>" 
                var str4="<p>"+value.desc+"</p>"
                var str5="<div class='footer-timeline'><ul class='timeline-option'><li class='option-row'><div class='row'>" 
                var str6="<div class='col-xs-6'><ol> <li><a class='label label-info'>评论</a></li></ol></div>" 
                var str7="<div class='col-xs-6 text-right'><ol><li><a class='btn btn-white'> <span class='text'>" 
                var str8="<i class='fa fa-thumbs-up text-success'></i> 25 </span></a></li>"
                var str9="<li><a class='btn btn-white'> <span class='text'><i class='fa fa-comments text-info'></i> 3 </span></a>"        
                var str10="</li></ol></div></div> </li>" 
                var str11="<li class='option-row'><img alt='Avatar' class='avatar' src='/img/avatar/avatar-1.jpg'>"
                var str12="<div class='reply'><form role='form'><input type='text' placeholder='填写你的反馈...' class='form-control input-sm' id=comment"+value.id+ ">"                  
                var str13="<input  type='button' value='发表' id='fb' class='input-btn' onclick=addComment("+value.id+",1) /></form></div></li>" 
                var str14="";
                $.each(value.comment,function(i,child){
               		//console.log(child);               	   
            	  	var child1=" <li class='option-row'> <img alt='Avatar' class='avatar' src='/img/avatar/avatar-2.jpg'>"
            	  	
            	  	var child2=" <div class='reply'><p><strong><a class='label bg-success m-l-xs'>"+child.name+"</a></strong>"
            	  	var nowtime= new Date().getTime();
            	  	var beforetime=parseInt((nowtime-child.time*1000)/3600000);
                  	var child3=child.desc+"</p>   <p class='text-muted reply-time'>"+beforetime+" 小时前</p></div> </li>"
                  	str14=str14+child1+child2+child3;
                });                   
                var str15="</ul> </div></div></li>"                
                var str=str1+str2+str3+str4+str5+str6+str7+str8+str9+str10+str11+str12+str13+str14+str15;                     
                $("#comment").append(str);                        
           });


        },
        error:function(){

        }
    });	
	}
	loadData();
	
	function add(){
		var zjk=document.getElementById('zjk').value;
		console.log(zjk)
		$.ajax({
		    	url:'http://202.202.2.42:82/handler/post_comment',
		    	type:'post',
		    	data :
			        {"pid" : '',
			        "comment" : zjk,
			        "eid" : eid 
			      },			    
		    	dataType:'json',
		    	success:function(data){
					console.log(data);		    		
		    		if(data.res == 1){
		    			alert('发表成功！')
		    			loadData();
		    		}else{
		    			alert('评论失败！');
		    		}
		    		
		    	},
		    	error:function(){
		    		
		    	}
		});	
	}



	
	function addComment(value,type){
		//父亲节点ID获取到了
		var id="";
		if(type==1){
		 id=value;
		 var comment = $("#comment"+id).val();
			if(comment.length>200){ 
				alert("字数不能超过200！");
				return;
			}
			var eid=document.getElementById('eid').value;
			console.log(comment);
		    $.ajax({
		    	url:'http://202.202.2.42:82/handler/post_comment',
		    	type:'post',
		    	data :
			        {"pid" : id,
			        "comment" : comment,
			        "eid" :eid
			      },			    
		    	dataType:'json',
		    	success:function(data){
		    		
		    		
		    		if(data.res == 1){
		    			alert('发表成功！')
		    		}else{
		    			alert('评论失败！');
		    		}		    			    		
		    	},
		    	error:function(){
		    		
		    	}
		    });
		}else{
			id=value;
			var comment = $("#comment"+id).val();
			if(comment.length>200){ 
				alert("字数不能超过200！");
				return;
			}
			var eid=document.getElementById('eid').value;
		    $.ajax({
		    	url:'http://202.202.2.42:82/handler/post_comment',
		    	type:'post',
		    	data :
			        {"pid" : '',
			        "comment" : comment,
			        "eid" : 1 
			      },			    
		    	dataType:'json',
		    	success:function(data){
		    		
		    		if(data.res == 1){
		    			alert('发表成功！')
		    		}else{
		    			alert('评论失败！');
		    		}		    			    		
		    	},
		    	error:function(){
		    		
		    	}
		    });
		}				
	}


	function tagier(){
		$("#wc").hide();
		var canshow=document.getElementById("cs");
		if(canshow.value==1){
			canshow.type="text";
			$("#sjwc").click(function(){
				var eid= document.getElementById("eid").value;
				$.ajax({
			    	url:'http://202.202.2.42:82/handler/confirm_done',
			    	type :'post',
			    	data : 'eid='+eid,			    
			    	dataType:'json',
			    	success:function(data){		
			    		console.log(data.res);
			    		if(data.res==1){
			    			document.getElementById("wc").style.display="";		   
			    			$('input').attr("readonly","readonly");
			    		}else{
			    			document.getElementById("wc").style.display="none";
			    		}
			    	},
			    	error:function(){
			    		
			    	}
				});
			})
		}
	}  	
	tagier();
	
//  function gettasK(){
//  	$.ajax({
//  		url:'http://202.202.2.42:82/hanlder/get_tasks_num',
//  		type:'get',
//  		dataType:'json',
//  		success:function(data){
//  			if(data!=null){
//	    			alert(JSON.stringify(data));
//	    			var untask=data.unread_num;// 未处理事件数
//	    			var dotask=data.doing_num;//正在处理数
//	    			var completetask=data.done_num;//已完成事件数
//  			}
//  		}
//  	});
//  }
//  gettasK();
	
    
</script>