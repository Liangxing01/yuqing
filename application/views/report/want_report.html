<!-- BEGIN MAIN CONTENT -->
<section id="main-content">
    <!-- BEGIN WRAPPER  -->
    <section class="wrapper site-min-height">
        <!-- BEGIN ROW  -->
        <div class="row">
            <div class="col-lg-12">
                <section class="panel">
                    <header class="panel-heading">
                        <span class="label label-primary">我要提交</span>
                        <span class="tools pull-right">
                           <a href="javascript:;" class="fa fa-chevron-down"></a>
                           <a href="javascript:;" class="fa fa-times"></a>
                           </span>
                    </header>
                    <div class="panel-body">
                        <form id="form1" class="form-horizontal tasi-form layui-form" enctype="multipart/form-data">
                            <input type="hidden" id="id" name="id"/>
                            <div class="form-group">
                                <label class="col-sm-2 col-sm-2 control-label">标题</label>
                                <div class="col-sm-10">
                                    <input type="text" name="title" id="title" required lay-verify="required" placeholder="请输入标题" autocomplete="off" class="form-control layui-input">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 col-sm-2 control-label">URL</label>
                                <div class="col-sm-10">
                                    <input type="text" name="url" id="url" required lay-verify="required" placeholder="请输入事件来源的网址" autocomplete="off" class="form-control layui-input" onblur="active.judgeUrl()">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 col-sm-2 control-label">截图</label>
                                <input type="file" id="file_name" name="file_name" >
                            </div>

                            <div class="form-group">
                                <label class="col-sm-2 col-sm-2 control-label">来源</label>
                                <div class="col-sm-10">
                                    <select name="city" lay-verify="" id="source" name="source" onchange="active.changeSelect(this)">
                                        <option value="天涯">天涯</option>
                                        <option value="大渝网">大渝网</option>
                                        <option value="问政平台">问政平台</option>
                                        <option value="看巴南APP">看巴南APP</option>
                                        <option value="微博">微博</option>
                                        <option value="微信">微信</option>
                                        <option value="线下">线下</option>
                                        <option value="other">其它</option>
                                        <input type="text" id="other" name="other" style="display:none"/>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 col-sm-2 control-label">描述</label>
                                <div class="col-sm-10">
                                    <input type="text" name="description" id="description" required lay-verify="required" placeholder="请输入事件描述" autocomplete="off" class="form-control layui-input">
                                </div>
                            </div>

                        </form>
                        <div class="text-center ">
                            <button id="submit1" class="btn btn-success btn-lg" onclick="active.setTop()">提交</button>
                        </div>
                    </div>
                </section>
            </div>
        </div>
        </div>
        <!-- END WRAPPER  -->
    </section>
    <!-- END MAIN CONTENT -->

</section>
<script>

    var active = {
        setTop : function () {
            var title = $("#title").val();
            var desc = $("#description").val();
            var url = $("#url").val();
            if(title.length < 5){
                layer.tips('标题必须大于5个字','#title',{
                    tips:[2,'#78BA32']
                });
                return;
            }
            if (url.length == 0){
                layer.tips('url不能为空','#url',{
                   tips:[2,'#78BA32']
                });
                return;
            }
            if (desc.length == 0){
                layer.tips('描述不能为空','#description',{
                    tips:[2,'#78BA32']
                });
                return;
            }
            if(desc.length > 200){
                layer.tips('描述过长，请不要超过200个字','#description',{
                    tips:[2,'#78BA32']
                });
                return;
            }
            layer.open({
                type:1
                ,title:false
                ,closeBtn:false
                ,area:'300px;'
                ,shade:0.8
                ,id:'submit'
                ,content:'<div style="padding: 50px; line-height: 22px; background-color: #393D49; color: #fff; font-weight: 300;">您确定要提交吗？</div>'
                ,btn:['确认提交','取消提交']
                ,moveType:1
                ,yes:function (index) {
                    var result =  active.judgeUrl();
                    if (result == false){
                        layer.close(index);
                    }else {
                        var formdata = $('#form1').serializeArray();
                        $.post('/Reporter/reportOrUpdate',{data:formdata},function (data) {
                            if (data.res == 1){
                                layer.msg('上传成功!');
                            }else {
                                layer.msg('上报失败！',{anim:6});
                            }
                            window.location = "/Reporter/reportRecording";
                        },"json");
                    }
                }
                ,btn2:function () {
                    layer.close();
                }
            })
        },

        judgeUrl : function () {
            var this_url = $('#url').val();
            var result = active.repeatUrl(this_url);
            if (result==false){
                layer.tips('您输入的不是一个正确的url地址','#url',{
                   tips: [2,'#78BA32']
                });
                return false;
            }
            res = true;

            $.post('/Reporter/judge_url',{url:this_url},function (data) {
                if (data == 1){
                    layer.tips('该url已经上报过了，请重新输入','#url',{
                        tips:[2,'#78BA32']
                    });
                    res = false;
                }
                if (data == -1){
                    layer.tips('url不能为空，请重新输入','#url',{
                        tips:[2,'#78BA32']
                    });
                    res = false;
                }
            }(res),"text");
            return res;
        },

        repeatUrl:function (url) {
            var strRegex=/((https|http|ftp|rtsp|mms):\/\/)?(([0-9a-z_!~*'().&=+$%-]+:)?[0-9a-z_!~*'().&=+$%-]+@)?(([0-9]{1,3}\.){3}[0-9]{1,3}|([0-9a-z_!~*'()-]+\.)*([0-9a-z][0-9a-z-]{0,61})?[0-9a-z]\.[a-z]{2,6})(:[0-9]{1,4})?((\/?)|(\/[0-9a-z_!~*'().;?:@&=+$,%#-]+)+\/?)/g;
            var re = new RegExp(strRegex);
            return re.test(url);
        },


        changeSelect :function(){
            $("#source").val() == 'other'?$("#other").css("display","block"):$("#other").css("display","none");
        }
    }

</script>